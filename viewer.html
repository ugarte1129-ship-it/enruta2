<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Viewer En Ruta</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f5f5f5;
}

/* ----------------- HEADER CON DEGRADADO REAL DE TU IMAGEN ----------------- */
.header {
    width: 100%;
    padding: 22px 0;
    background: linear-gradient(to right, #A56CFB, #9E63FA, #9058F9);
    text-align: center;
    font-size: 26px;
    font-weight: bold;
    color: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.25);
    position: relative;
    z-index: 2000;
}

/* ----------------- SELECTOR IGUAL AL DE LA CAPTURA ----------------- */
.selector {
    width: 100%;
    text-align: center;
    position: absolute;
    top: 95px;
    z-index: 1500;
}

.selector-box {
    background: white;
    display: inline-flex;
    gap: 10px;
    padding: 14px 20px;
    border-radius: 15px;
    box-shadow: 0px 3px 10px rgba(0,0,0,0.15);
}

.selector select {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 150px;
}

.selector button {
    padding: 8px 18px;
    background: #7b2cbf;
    border: none;
    color: white;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}

.selector button:hover {
    background: #5a189a;
}

/* --------- MAPA --------- */
#map {
    height: 100vh;
    width: 100vw;
}

.leaflet-tile {
    filter: grayscale(60%) brightness(115%);
}

/* --------- MARCADOR ANIMADO --------- */
.loader {
    width:48px;
    height:48px;
    position:relative;
}
.loader::after {
    content:'';
    width:48px;
    height:48px;
    border-radius:50% 50% 0;
    border:15px solid #9b59b6;
    position:absolute;
    bottom:0;
    transform: rotate(45deg);
    animation: jump 0.4s ease-in-out infinite alternate;
}
.loader::before {
    content:'';
    width:24px;
    height:5px;
    background: rgba(0,0,0,0.25);
    border-radius:50%;
    position:absolute;
    top: 140%;
    left:50%;
    transform: translateX(-50%);
    animation: shadow 0.4s ease-in-out infinite alternate;
}

@keyframes jump {
    0% { transform: rotate(45deg) translate(5px,5px); }
    100% { transform: rotate(45deg) translate(-5px,-5px); }
}
@keyframes shadow {
    0% { transform: scale(0.5); }
    100% { transform: scale(1); }
}
</style>
</head>
<body>

<div class="header">En ruta: Ubica tu transporte</div>

<!-- GLOBO ELIMINADO COMPLETAMENTE -->

<div class="selector">
    <div class="selector-box">
        <select id="unitSelect">
            <option value="">ID del Autobús</option>
            <option value="RA">RA</option>
            <option value="RP">RP</option>
            <option value="RV">RV</option>
            <option value="RS">RS</option>
        </select>

        <button id="connectBtn">Conectar</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>

/* ----------------- FIREBASE ----------------- */
const firebaseConfig = {
    apiKey: "AIzaSyA5pec-pqAnksqEKocrUv0HImO0H-qINDY",
    authDomain: "pgps-252ee.firebaseapp.com",
    databaseURL: "https://pgps-252ee-default-rtdb.firebaseio.com/",
    projectId: "pgps-252ee",
    storageBucket: "pgps-252ee.appspot.com",
    messagingSenderId: "310435537463",
    appId: "1:310435537463:web:9a0086d69a05b3b7fb2537"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ----------------- MAPA ----------------- */
const map = L.map("map").setView([19.4326, -99.1332], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ❌ LÍNEA AMARILLA ELIMINADA */

/* ----------------- MARCADORES ----------------- */
let busMarker = null;
let myLocationMarker = null;

function moveBus(coords) {
    if (!busMarker) {
        busMarker = L.marker(coords, {
            icon: L.divIcon({
                className: "loader",
                iconSize: [48,48],
                iconAnchor: [24,48]
            })
        }).addTo(map);
    } else {
        busMarker.setLatLng(coords);
    }
}

/* ----------------- UBICACIÓN DEL USUARIO ----------------- */
function updateMyLocation(pos) {
    const coords = [pos.coords.latitude, pos.coords.longitude];

    if (!myLocationMarker) {
        myLocationMarker = L.marker(coords, {
            icon: L.icon({
                iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
                iconSize: [32,32],
                iconAnchor: [16,32]
            })
        }).addTo(map);
    } else {
        myLocationMarker.setLatLng(coords);
    }
}

if (navigator.geolocation) {
    navigator.geolocation.watchPosition(updateMyLocation);
}

/* ----------------- CONEXIÓN FIREBASE ----------------- */
const unitSelect = document.getElementById("unitSelect");
const connectBtn = document.getElementById("connectBtn");

let activeRef = null;

connectBtn.addEventListener("click", () => {
    const id = unitSelect.value;

    if (!id) return alert("Selecciona un autobús");

    if (activeRef) activeRef.off();

    activeRef = db.ref("ubicacion/" + id);

    activeRef.on("value", snap => {
        const data = snap.val();
        if (!data) return;

        moveBus([data.lat, data.lng]);
    });
});
</script>

</body>
</html>
