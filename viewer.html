<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Viewer con Ruta Fija RA</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }
    .selector {
      position: absolute;
      top: 15px;
      left: 15px;
      background: white;
      padding: 12px;
      border-radius: 12px;
      z-index: 1000;
      box-shadow: 0px 3px 8px rgba(0,0,0,0.15);
    }
    select { padding: 8px; width: 160px; margin-right: 10px; }
    button {
      padding: 8px 16px;
      background-color: #9b59b6;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: #555;
      z-index: 1000;
      background: rgba(255,255,255,0.85);
      padding: 12px 20px;
      border-radius: 10px;
      text-align: center;
    }

    .loader {
      width: 48px;
      height: 48px;
      display: block;
      box-sizing: border-box;
      position: relative;
    }
    .loader::after {
      content: '';
      width: 48px;
      height: 48px;
      left: 0;
      bottom: 0;
      position: absolute;
      border-radius: 50% 50% 0;
      border: 15px solid #9b59b6;
      transform: rotate(45deg) translate(0,0);
      box-sizing: border-box;
      animation: animMarker 0.4s ease-in-out infinite alternate;
    }
    .loader::before {
      content: '';
      box-sizing: border-box;
      position: absolute;
      left:0; right:0; margin:auto;
      top:150%;
      width:24px; height:4px;
      border-radius:50%;
      background: rgba(0,0,0,0.2);
      animation: animShadow 0.4s ease-in-out infinite alternate;
    }
    @keyframes animMarker { 0% { transform: rotate(45deg) translate(5px,5px); } 100% { transform: rotate(45deg) translate(-5px,-5px); } }
    @keyframes animShadow { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

    .leaflet-tile { filter: grayscale(60%) brightness(110%); }
  </style>
</head>
<body>

  <div id="message">Ubica tu ruta</div>

  <div class="selector">
    <label>En ruta: ubica tu transporte</label><br>
    <select id="unitSelect">
      <option value="">Selecciona unidad</option>
      <option value="RA">RA</option>
      <option value="RP">RP</option>
      <option value="RV">RV</option>
      <option value="RS">RS</option>
    </select>
    <button id="connectBtn">Conectar</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA5pec-pqAnksqEKocrUv0HImO0H-qINDY",
      authDomain: "pgps-252ee.firebaseapp.com",
      databaseURL: "https://pgps-252ee-default-rtdb.firebaseio.com/",
      projectId: "pgps-252ee",
      storageBucket: "pgps-252ee.appspot.com",
      messagingSenderId: "310435537463",
      appId: "1:310435537463:web:9a0086d69a05b3b7fb2537"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const map = L.map('map').setView([25.423, -100.992], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let marker = null;
    let routeLine = null;
    const unitSelect = document.getElementById("unitSelect");
    const message = document.getElementById("message");
    const connectBtn = document.getElementById("connectBtn");
    let activeListener = null;

    // Tu API Key de OpenRouteService
    const ORS_API_KEY = "TU_API_KEY_ORS";

    async function drawFixedRoute() {
      // Coordenadas de inicio y fin para la ruta
      const start = [-100.9950, 25.4252]; // AsunciÃ³n (lng, lat)
      const end = [-100.9920, 25.4230];   // IT Saltillo aprox (lng, lat)

      const body = {
        coordinates: [start, end],
        profile: "driving-car",
        format: "geojson"
      };

      const res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car", {
        method: "POST",
        headers: {
          "Authorization": ORS_API_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      const json = await res.json();
      // Dibujar la ruta
      routeLine = L.geoJSON(json, { style: { color: "yellow", weight: 5 } }).addTo(map);
    }

    drawFixedRoute();

    function moveMarker(point) {
      if (!marker) {
        marker = L.marker(point, {
          icon: L.divIcon({ className: 'loader', iconSize: [48,48], iconAnchor: [24,48] })
        }).addTo(map);
      } else {
        marker.setLatLng(point);
      }
      map.setView(point, 15);
    }

    connectBtn.addEventListener("click", () => {
      const busID = unitSelect.value;
      if (!busID) { alert("Selecciona una unidad"); return; }

      message.style.display = "none";

      if (activeListener) activeListener.off();
      activeListener = db.ref("ubicaciones/" + busID);
      activeListener.on("value", snapshot => {
        const data = snapshot.val();
        if (!data || !data.lat || !data.lng) return;
        moveMarker([data.lat, data.lng]);
      });
    });
  </script>
</body>
</html>
